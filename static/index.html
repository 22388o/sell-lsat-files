<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet"
          href="static/style.css">
    <title>LSAT Instagram</title>
</head>
<body>
    <!-- Code for Showing the Status -->
    <main>
        <div class="container">
            <div class="col-9">
                
              <!-- Code for viewing the Post -->
				{{ range .Entries }}
                <div class="card">
                    <div class="top">
                        <div class="userDetails">
                            <div class="profilepic">
                                <div class="profile_img">
                                    <div class="image">
                                        <img src=
"https://media.geeksforgeeks.org/wp-content/uploads/20220609093229/g-200x200.png" 
                                            alt="img8">
                                    </div>
                                </div>
                            </div>
                            <h3>{{ .Name }} - {{ .Price }} sats
                                  <br>
                                  <span>{{ .LNAddress}}</span>
                          </h3>
                        </div>
                        <div>
                            <span class="dot">
                                <i class="fas fa-ellipsis-h"></i>
                            </span>
                        </div>
                    </div>
                    <div class="imgBx">
                        <img src="{{ .URL }}" id="{{ .URL }}"
							onclick="fetchLSAT({{ .URL }})"
                            class="cover">
                    </div>
                    <div class="bottom">
                        <a href="#">
                            <p class="likes">{{ .NrOfDownloads}} downloads</p>
                            <p class="likes">{{ .SatsEarned}} sats earned</p>
                        </a>
                        <a href="#">
                            <p class="message">
                              <b>{{ .TimeAgo}}</b>
                            </p>
                        </a>
                    </div>
                </div>
				{{ end }}
            </div>
            <div class="col-3">
                <div class="card">
                    <h4>Upload your images</h4>
					<form id="uploadbanner" enctype="multipart/form-data" method="post" action="/upload" target="/" class="col-3">
						<input id="fileupload" name="file" type="file" />
						<br>
						<label for="lnaddress">Lightning Address</label>
						<input id="lnaddress" name="ln_address" type="text" />
						<br>
						<label for="price">Price in sats</label>
						<input id="price" name="price" type="number" />
						<br>
						<input type="submit" value="submit" id="submit" />
					 </form>
                </div>
                
             <!-- Our Footer Section will start from Here -->
                <div class="footer">
                    <a class="footer-section" href="#">About</a>
                    <a class="footer-section" href="#">Help</a>
                    <a class="footer-section" href="#">Privacy</a>
                    <a class="footer-section" href="#">Terms</a>
                    <br>
                    <a class="footer-section" href="#">Top Accounts</a>
                    <a class="footer-section" href="#">Hashtag</a>
                    <a class="footer-section" href="#">Language</a>
                    <br><br>
                    <span class="footer-section">
                        Â© 2023 GETALBY.COM
                    </span>
                </div>
            </div>
        </div>
    </main>
</body>
<script
  src="https://unpkg.com/webln@0.2.0/dist/webln.min.js"
  integrity="sha384-mTReBqbhPO7ljQeIoFaD1NYS2KiYMwFJhUNpdwLj+VIuhhjvHQlZ1XpwzAvd93nQ"
  crossorigin="anonymous"
></script>
<script>
async function fetchLSAT(url) {
	fetched = localStorage.getItem(url);
	if (fetched != null) {
		fetched = JSON.parse(fetched)
		await fetchImg(url, fetched.mac, fetched.preimage)
		return
	}
	resp = await fetch(url, {headers: {"Accept": "application/vnd.lsat.v1.full"}})
    const header = resp.headers.get('www-authenticate')
	// show some information about the lsat
	parts = header.split(",")
	mac = parts[0].replace("LSAT macaroon=", "").trimStart()
	inv = parts[1].replace("invoice=", "").trimStart()
	webln = await WebLN.requestProvider();
	await webln.enable()
	invResp = await webln.sendPayment(inv)
	localStorage.setItem(url, JSON.stringify({'mac': mac, 'preimage': invResp.preimage}));
	await fetchImg(url, mac, invResp.preimage)

}
async function fetchImg(url, mac, preimage) {
	resp = await fetch(url, {headers: {"Authorization": `LSAT ${mac}:${preimage}`}})
	const blob = await resp.blob();
  	const objectUrl = URL.createObjectURL(blob);
  	const imageElement = document.getElementById(url);
  	imageElement.src = objectUrl;
}
</script>
</html>